<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f1115">
<title>Album Rater — Simple UI</title>
<style>
:root{
  --c10:#2e47ee; --c9:#0285c6; --c8:#02aec6; --c7:#23be32; --c6:#f0ca15; --c5:#e12928;
  --bg:#0f1115; --panel:#161a22; --ink:#e9edf1; --muted:#aeb5c0; --line:#2a3140; --accent:#8aa0ff;
}
*{box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,'Noto Sans',sans-serif;margin:0}
.wrap{max-width:1100px;margin:18px auto;padding:0 16px 60px}
h1{font-size:20px;margin:0 0 2px 0}
.sub{color:var(--muted);font-size:13px;margin-bottom:12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.pad{padding:14px}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.pair{display:grid;grid-template-columns: 140px 1fr;gap:8px;align-items:center;margin-bottom:8px}
.label{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
button{background:#22304b;border:1px solid var(--line);color:#cdd7f5;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
button.primary{background:#2b3e6b;color:#fff;border-color:#425a95}
.row{display:grid;grid-template-columns:60px 90px 1fr 160px 90px;gap:8px;align-items:center;margin-bottom:6px}
.row input, .row select{background:#0e1218;border:1px solid var(--line);color:var(--ink);padding:10px;border-radius:10px;font-size:14px}
.pill{display:inline-flex;justify-content:center;align-items:center;padding:6px 10px;border-radius:8px;color:white;font-weight:800;letter-spacing:.3px;min-width:52px;text-align:center}
.cover{width:100%;aspect-ratio:1/1;object-fit:cover;border:1px solid var(--line);border-radius:10px;background:#0d1117}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:14px}
th{color:var(--muted);font-weight:600}
.final{font-size:52px;font-weight:800;text-align:center;margin-top:10px}
canvas{width:100%;height:320px;border:1px solid var(--line);border-radius:12px;background:#0e1218}
.smallmuted{font-size:12px;color:var(--muted)}
.tag{padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#0e1218;color:#cbd5e1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Album Rater</h1>
  <div class="sub">Interfaz rápida: elige cantidad de canciones, selecciona Rank con dos toques (entero y decimal), se calcula el promedio y se grafica al instante.</div>

  <div class="grid">
    <div class="card pad">
      <div class="pair"><div class="label">Álbum</div><input id="album" placeholder="Nombre del álbum"></div>
      <div class="pair"><div class="label">Artista</div><input id="artist" placeholder="Artista"></div>
      <div class="pair"><div class="label">Lanzamiento</div><input id="released" placeholder="1 Ago 2025"></div>
      <div class="pair"><div class="label">Cover</div><input id="cover" type="file" accept="image/*"></div>
      <div class="pair"><div class="label">Canciones</div><input id="trackcount" type="number" min="1" value="7"></div>
      <div class="controls">
        <button id="applyCount">Aplicar cantidad</button>
        <button id="addRow">+ Añadir fila</button>
        <button id="delRow">– Quitar última</button>
      </div>

      <div class="row" style="font-size:12px;color:var(--muted)">
        <div>#</div><div>Duración</div><div>Nombre</div><div>Rank (entero + decimal)</div><div>Color</div>
      </div>
      <div id="tracks"></div>
    </div>

    <div class="card pad">
      <div style="display:grid;grid-template-columns:1fr 360px;gap:16px">
        <div>
          <div style="display:grid;grid-template-columns:auto 1fr;column-gap:12px;row-gap:6px;align-items:center" id="info"></div>
          <table id="table"></table>
        </div>
        <div>
          <img id="coverOut" class="cover" alt="Cover">
          <div class="final" id="finalScore">—</div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="smallmuted" style="margin:6px 0">Enjoyment Timeline</div>
        <canvas id="chart" width="900" height="360"></canvas>
      </div>
    </div>
  </div>

  <div class="smallmuted" style="margin-top:8px">Colores: 10 #2e47ee, 9 #0285c6, 8 #02aec6, 7 #23be32, 6 #f0ca15, 5 #e12928</div>
</div>

<script>
const COLORS = {10:'#2e47ee',9:'#0285c6',8:'#02aec6',7:'#23be32',6:'#f0ca15',5:'#e12928'};
const $ = s => document.querySelector(s);

function durationToSeconds(d){
  if(!d) return 0;
  const m = d.match(/^(\\d{1,2}):(\\d{2})$/);
  if(!m) return 0;
  return parseInt(m[1],10)*60 + parseInt(m[2],10);
}
function secondsToMinutesText(s){
  const m = Math.round(s/60);
  return m? m + ' min' : '—';
}
function colorFor(score){
  const k = Math.max(5, Math.min(10, Math.floor(Number(score)||0)));
  return COLORS[k];
}

const tracksEl = document.getElementById('tracks');

function rankPicker(intVal, decVal){
  intVal = (typeof intVal==='number')? intVal : 8;
  decVal = (typeof decVal==='number')? decVal : 0;
  const wrap = document.createElement('div');
  wrap.style.display='grid';
  wrap.style.gridTemplateColumns='1fr 1fr';
  wrap.style.gap='6px';
  const iSel = document.createElement('select');
  for(let i=5;i<=10;i++){
    const o = document.createElement('option'); o.value=i; o.textContent=i;
    if(i===intVal) o.selected=true; iSel.appendChild(o);
  }
  const dSel = document.createElement('select');
  const fillDecimals = (max)=>{
    dSel.innerHTML='';
    const maxTenths = max? 9 : 0;
    for(let t=0; t<=maxTenths; t++){
      const val = (t/10).toFixed(1);
      const o = document.createElement('option'); o.value=val; o.textContent=val;
      if(Number(val)===decVal) o.selected=true;
      dSel.appendChild(o);
    }
  };
  fillDecimals(intVal<10);
  iSel.addEventListener('change', ()=>{
    if(Number(iSel.value)===10){ fillDecimals(false); }
    else { fillDecimals(true); }
    trigger();
  });
  dSel.addEventListener('change', trigger);
  wrap.appendChild(iSel); wrap.appendChild(dSel);
  function value(){ return Number(iSel.value) + Number(dSel.value); }
  function set(v){
    const base = Math.floor(v);
    const dec = Math.round((v - base)*10)/10;
    iSel.value = base;
    fillDecimals(base<10);
    dSel.value = dec.toFixed(1);
  }
  function trigger(){
    wrap.dispatchEvent(new CustomEvent('change-score', {detail:value()}));
  }
  set(intVal + decVal);
  return {el:wrap, get:value, set:set, iSel:iSel, dSel:dSel};
}

function makeRow(i, data){
  data = data || {};
  const row = document.createElement('div');
  row.className = 'row';
  const n = document.createElement('input'); n.type='number'; n.min=1; n.value=(data.n ?? (i+1));
  const dur = document.createElement('input'); dur.placeholder='mm:ss'; dur.value=data.dur??'';
  const name = document.createElement('input'); name.placeholder='Nombre de la canción'; name.value=data.name??'';
  const base = Math.floor((data.score??8));
  const dec = Number((((data.score??8) - base).toFixed(1)));
  const picker = rankPicker(base, dec);
  const pill = document.createElement('div'); pill.className='pill'; pill.textContent='—';
  row.append(n, dur, name, picker.el, pill);
  function paint(v){
    const c = colorFor(v||0);
    pill.style.background = c; pill.textContent = (v||0).toFixed(1).replace(/\.0$/,'');
  }
  picker.el.addEventListener('change-score', e=>{ paint(e.detail); render(); });
  [n,dur,name].forEach(el=> el.addEventListener('input', render));
  paint(picker.get());
  row.value = ()=> ({ n:Number(n.value||0), dur:dur.value.trim(), name:name.value.trim(), score:picker.get() });
  return row;
}

function ensureRows(n){
  const cur = tracksEl.children.length;
  if(cur<n){ for(let i=cur;i<n;i++) tracksEl.appendChild(makeRow(i)); }
  else if(cur>n){ for(let i=cur-1;i>=n;i--) tracksEl.removeChild(tracksEl.children[i]); }
  render();
}

document.getElementById('addRow').onclick = ()=> ensureRows(tracksEl.children.length+1);
document.getElementById('delRow').onclick = ()=> ensureRows(Math.max(1, tracksEl.children.length-1));
document.getElementById('applyCount').onclick = ()=> ensureRows(parseInt(document.getElementById('trackcount').value||'1',10));

document.getElementById('cover').addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => document.getElementById('coverOut').src = e.target.result;
  r.readAsDataURL(f);
});

function render(){
  const album = document.getElementById('album').value.trim();
  const artist = document.getElementById('artist').value.trim();
  const released = document.getElementById('released').value.trim();
  const info = document.getElementById('info'); info.innerHTML='';
  const pair = (L,V)=>{ const l=document.createElement('div'); l.className='label'; l.textContent=L;
    const v=document.createElement('div'); v.innerHTML=V; info.append(l,v); };
  pair('Album:', '<strong><em>'+(album||'—')+'</em></strong>');
  pair('Artist:', '<strong>'+(artist||'—')+'</strong>');
  pair('Released:', released||'—');

  const tracks = [...tracksEl.children].map(row => row.value()).filter(t=>t.name||t.dur||t.score);
  tracks.sort((a,b)=> a.n - b.n);

  const table = document.getElementById('table'); table.innerHTML='';
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th style="width:80px">Duration</th><th style="width:36px">#</th><th>Name</th><th style="width:90px">Rank</th></tr>';
  table.appendChild(thead);
  const tbody = document.createElement('tbody'); table.appendChild(tbody);

  let totalSec = 0, scores=[];
  tracks.forEach(t=>{
    totalSec += durationToSeconds(t.dur);
    if(t.score>=5 && t.score<=10) scores.push(t.score);
    const pill = '<span class="pill" style="background:'+colorFor(t.score)+'">'+t.score.toFixed(1).replace(/\.0$/,'')+'</span>';
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+(t.dur||'—')+'</td><td>'+(t.n||'')+'</td><td>'+(t.name||'—')+'</td><td>'+pill+'</td>';
    tbody.appendChild(tr);
  });

  const avg = scores.length? (scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
  document.getElementById('finalScore').textContent = scores.length ? avg.toFixed(1) : '—';
  pair('Duration', secondsToMinutesText(totalSec));

  drawChart('chart', tracks.map(t=>t.score));
}

function drawChart(id, values){
  const canvas = document.getElementById(id);
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const P = {l:60,r:20,t:20,b:36}, W=canvas.width-P.l-P.r, H=canvas.height-P.t-P.b;
  ctx.strokeStyle='#2a3140'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(P.l,P.t); ctx.lineTo(P.l,P.t+H); ctx.lineTo(P.l+W,P.t+H); ctx.stroke();
  ctx.fillStyle='#aeb5c0'; ctx.font='12px system-ui';
  for(let y=5;y<=10;y++){
    const yy=P.t+H-((y-5)/5)*H;
    ctx.strokeStyle='#1a2130'; ctx.beginPath(); ctx.moveTo(P.l,yy); ctx.lineTo(P.l+W,yy); ctx.stroke();
    ctx.fillText(y.toFixed(0),18,yy+4);
  }
  if(!values.length) return;
  const n=values.length, x=i=>P.l+(i/(Math.max(1,n-1)))*W, y=v=>P.t+H-((v-5)/5)*H;
  ctx.strokeStyle='#7aa2ff'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(x(0),y(values[0]));
  for(let i=1;i<n;i++) ctx.lineTo(x(i), y(values[i])); ctx.stroke();
  ctx.fillStyle='#cfd9ff'; for(let i=0;i<n;i++){ ctx.beginPath(); ctx.arc(x(i), y(values[i]), 4, 0, 2*Math.PI); ctx.fill(); }
  ctx.fillStyle='#aeb5c0'; for(let i=0;i<n;i++){ ctx.fillText(String(i+1), x(i)-3, P.t+H+16); }
}

function seed(){
  const demo=[['02:17',1,'Distant Waves, Pt.1',8.0],['01:50',2,'Serenity',10.0],['01:49',3,'Dreamin At Plaza',8.7],['02:52',4,'ATS',10.0],['02:58',5,'Far In Paradise',7.4],['03:16',6,'Heaven, Pt. 3',7.8],['02:29',7,'It Always Ends',10.0]];
  document.getElementById('trackcount').value=demo.length;
  tracksEl.innerHTML='';
  demo.forEach((d,i)=> tracksEl.appendChild(makeRow(i,{n:d[1], dur:d[0], name:d[2], score:d[3]})) );
  document.getElementById('album').value='2023 Memories';
  document.getElementById('artist').value='Zuurkey Beatz';
  document.getElementById('released').value='August 1, 2025';
  render();
}
function ensureRows(n){
  const cur=tracksEl.children.length;
  if(cur<n){ for(let i=cur;i<n;i++) tracksEl.appendChild(makeRow(i)); }
  else if(cur>n){ for(let i=cur-1;i>=n;i--) tracksEl.removeChild(tracksEl.children[i]); }
  render();
}
document.getElementById('applyCount').onclick=()=> ensureRows(parseInt(document.getElementById('trackcount').value||'1',10));
document.getElementById('addRow').onclick=()=> ensureRows(tracksEl.children.length+1);
document.getElementById('delRow').onclick=()=> ensureRows(Math.max(1, tracksEl.children.length-1));

['album','artist','released'].forEach(id=> document.getElementById(id).addEventListener('input', render));

seed();

if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
}
</script>
</body>
</html>
